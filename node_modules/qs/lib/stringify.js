<<<<<<< HEAD
<<<<<<< HEAD
=======
>>>>>>> 35df532d073310745d0bf1b49f0ed615cabd29d8
'use strict';

var Utils = require('./utils');

var internals = {
    delimiter: '&',
    arrayPrefixGenerators: {
        brackets: function (prefix) {
            return prefix + '[]';
        },
        indices: function (prefix, key) {
            return prefix + '[' + key + ']';
        },
        repeat: function (prefix) {
            return prefix;
        }
    },
    strictNullHandling: false,
    skipNulls: false,
    encode: true
};

internals.stringify = function (object, prefix, generateArrayPrefix, strictNullHandling, skipNulls, encode, filter, sort) {
    var obj = object;
    if (typeof filter === 'function') {
        obj = filter(prefix, obj);
    } else if (Utils.isBuffer(obj)) {
        obj = String(obj);
    } else if (obj instanceof Date) {
        obj = obj.toISOString();
    } else if (obj === null) {
        if (strictNullHandling) {
            return encode ? Utils.encode(prefix) : prefix;
<<<<<<< HEAD
=======
// Load modules

var Utils = require('./utils');


// Declare internals

var internals = {
    delimiter: '&',
    arrayPrefixGenerators: {
        brackets: function (prefix, key) {

            return prefix + '[]';
        },
        indices: function (prefix, key) {

            return prefix + '[' + key + ']';
        },
        repeat: function (prefix, key) {

            return prefix;
        }
    },
    strictNullHandling: false
};


internals.stringify = function (obj, prefix, generateArrayPrefix, strictNullHandling, filter) {

    if (typeof filter === 'function') {
        obj = filter(prefix, obj);
    }
    else if (Utils.isBuffer(obj)) {
        obj = obj.toString();
    }
    else if (obj instanceof Date) {
        obj = obj.toISOString();
    }
    else if (obj === null) {
        if (strictNullHandling) {
            return Utils.encode(prefix);
>>>>>>> cec199920473bbfd13a946ef7466a6f270502933
=======
>>>>>>> 35df532d073310745d0bf1b49f0ed615cabd29d8
        }

        obj = '';
    }

<<<<<<< HEAD
<<<<<<< HEAD
=======
>>>>>>> 35df532d073310745d0bf1b49f0ed615cabd29d8
    if (typeof obj === 'string' || typeof obj === 'number' || typeof obj === 'boolean') {
        if (encode) {
            return [Utils.encode(prefix) + '=' + Utils.encode(obj)];
        }
        return [prefix + '=' + obj];
<<<<<<< HEAD
=======
    if (typeof obj === 'string' ||
        typeof obj === 'number' ||
        typeof obj === 'boolean') {

        return [Utils.encode(prefix) + '=' + Utils.encode(obj)];
>>>>>>> cec199920473bbfd13a946ef7466a6f270502933
=======
>>>>>>> 35df532d073310745d0bf1b49f0ed615cabd29d8
    }

    var values = [];

    if (typeof obj === 'undefined') {
        return values;
    }

<<<<<<< HEAD
<<<<<<< HEAD
=======
>>>>>>> 35df532d073310745d0bf1b49f0ed615cabd29d8
    var objKeys;
    if (Array.isArray(filter)) {
        objKeys = filter;
    } else {
        var keys = Object.keys(obj);
        objKeys = sort ? keys.sort(sort) : keys;
    }

    for (var i = 0; i < objKeys.length; ++i) {
        var key = objKeys[i];

        if (skipNulls && obj[key] === null) {
            continue;
        }

        if (Array.isArray(obj)) {
            values = values.concat(internals.stringify(obj[key], generateArrayPrefix(prefix, key), generateArrayPrefix, strictNullHandling, skipNulls, encode, filter));
        } else {
            values = values.concat(internals.stringify(obj[key], prefix + '[' + key + ']', generateArrayPrefix, strictNullHandling, skipNulls, encode, filter));
<<<<<<< HEAD
=======
    var objKeys = Array.isArray(filter) ? filter : Object.keys(obj);
    for (var i = 0, il = objKeys.length; i < il; ++i) {
        var key = objKeys[i];

        if (Array.isArray(obj)) {
            values = values.concat(internals.stringify(obj[key], generateArrayPrefix(prefix, key), generateArrayPrefix, strictNullHandling, filter));
        }
        else {
            values = values.concat(internals.stringify(obj[key], prefix + '[' + key + ']', generateArrayPrefix, strictNullHandling, filter));
>>>>>>> cec199920473bbfd13a946ef7466a6f270502933
=======
>>>>>>> 35df532d073310745d0bf1b49f0ed615cabd29d8
        }
    }

    return values;
};

<<<<<<< HEAD
<<<<<<< HEAD
=======
>>>>>>> 35df532d073310745d0bf1b49f0ed615cabd29d8
module.exports = function (object, opts) {
    var obj = object;
    var options = opts || {};
    var delimiter = typeof options.delimiter === 'undefined' ? internals.delimiter : options.delimiter;
    var strictNullHandling = typeof options.strictNullHandling === 'boolean' ? options.strictNullHandling : internals.strictNullHandling;
    var skipNulls = typeof options.skipNulls === 'boolean' ? options.skipNulls : internals.skipNulls;
    var encode = typeof options.encode === 'boolean' ? options.encode : internals.encode;
    var sort = typeof options.sort === 'function' ? options.sort : null;
<<<<<<< HEAD
=======

module.exports = function (obj, options) {

    options = options || {};
    var delimiter = typeof options.delimiter === 'undefined' ? internals.delimiter : options.delimiter;
    var strictNullHandling = typeof options.strictNullHandling === 'boolean' ? options.strictNullHandling : internals.strictNullHandling;
>>>>>>> cec199920473bbfd13a946ef7466a6f270502933
=======
>>>>>>> 35df532d073310745d0bf1b49f0ed615cabd29d8
    var objKeys;
    var filter;
    if (typeof options.filter === 'function') {
        filter = options.filter;
        obj = filter('', obj);
<<<<<<< HEAD
<<<<<<< HEAD
    } else if (Array.isArray(options.filter)) {
=======
    }
    else if (Array.isArray(options.filter)) {
>>>>>>> cec199920473bbfd13a946ef7466a6f270502933
=======
    } else if (Array.isArray(options.filter)) {
>>>>>>> 35df532d073310745d0bf1b49f0ed615cabd29d8
        objKeys = filter = options.filter;
    }

    var keys = [];

<<<<<<< HEAD
<<<<<<< HEAD
    if (typeof obj !== 'object' || obj === null) {
=======
    if (typeof obj !== 'object' ||
        obj === null) {

>>>>>>> cec199920473bbfd13a946ef7466a6f270502933
=======
    if (typeof obj !== 'object' || obj === null) {
>>>>>>> 35df532d073310745d0bf1b49f0ed615cabd29d8
        return '';
    }

    var arrayFormat;
    if (options.arrayFormat in internals.arrayPrefixGenerators) {
        arrayFormat = options.arrayFormat;
<<<<<<< HEAD
<<<<<<< HEAD
    } else if ('indices' in options) {
        arrayFormat = options.indices ? 'indices' : 'repeat';
    } else {
=======
    }
    else if ('indices' in options) {
        arrayFormat = options.indices ? 'indices' : 'repeat';
    }
    else {
>>>>>>> cec199920473bbfd13a946ef7466a6f270502933
=======
    } else if ('indices' in options) {
        arrayFormat = options.indices ? 'indices' : 'repeat';
    } else {
>>>>>>> 35df532d073310745d0bf1b49f0ed615cabd29d8
        arrayFormat = 'indices';
    }

    var generateArrayPrefix = internals.arrayPrefixGenerators[arrayFormat];

    if (!objKeys) {
        objKeys = Object.keys(obj);
    }
<<<<<<< HEAD
<<<<<<< HEAD
=======
>>>>>>> 35df532d073310745d0bf1b49f0ed615cabd29d8

    if (sort) {
        objKeys.sort(sort);
    }

    for (var i = 0; i < objKeys.length; ++i) {
        var key = objKeys[i];

        if (skipNulls && obj[key] === null) {
            continue;
        }

        keys = keys.concat(internals.stringify(obj[key], key, generateArrayPrefix, strictNullHandling, skipNulls, encode, filter, sort));
<<<<<<< HEAD
=======
    for (var i = 0, il = objKeys.length; i < il; ++i) {
        var key = objKeys[i];
        keys = keys.concat(internals.stringify(obj[key], key, generateArrayPrefix, strictNullHandling, filter));
>>>>>>> cec199920473bbfd13a946ef7466a6f270502933
=======
>>>>>>> 35df532d073310745d0bf1b49f0ed615cabd29d8
    }

    return keys.join(delimiter);
};
